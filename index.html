<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Update version here and below in the visible area -->
  <title>Citation Bookmarklet â€” v2.5 8:48</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:900px; margin:40px auto; padding:0 20px; color:#111; }
    .bm { display:inline-block; padding:12px 18px; background:#111; color:#fff; border-radius:8px; text-decoration:none; font-weight:600; }
    button { margin-left:12px; padding:9px 12px; }
    pre { background:#f7f7f8; padding:10px; border-radius:6px; overflow:auto; white-space:pre-wrap; word-break:break-word; }
    .note { color:#555; font-size:0.95rem; margin-top:12px; }
    .version { font-size:13px; color:#666; margin-bottom:14px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  </style>
</head>
<body>

  <!--
    Bookmarklet version: 1.0.4
    Edit ONLY the "1.0.4" string in the two places below on each release.
    (1) <title> above
    (2) the visible version line below (PAGE_VERSION variable)
  -->
  <div class="version">Bookmarklet version: <strong id="version-text">1.0.4</strong></div>

  <h1>Install: Citation Bookmarklet</h1>

  <p>Drag the button below to your bookmarks bar to install the bookmarklet. If dragging doesn't work for you, click <strong>Copy bookmarklet</strong> and paste into a new bookmark's URL field.</p>

  <div class="row">
    <!-- Visible anchor users will drag; href will be set at runtime -->
    <a id="install-link" class="bm" href="#">ðŸ“š Cite Article</a>
    <button id="copy-btn" title="Copy bookmarklet code to clipboard">Copy bookmarklet</button>
  </div>

  <p class="note">If a user already installed an older bookmarklet, they must delete the old bookmark and re-drag the button (bookmarks don't update automatically).</p>

  <h3>Raw install code (for advanced users)</h3>
  <pre id="raw" aria-label="Bookmarklet code (minified)"></pre>

  <script>
    /*****************************************************************************
     * IMPORTANT:
     * The variable below (codeBody) must contain your minified bookmarklet body
     * as a single-line string WITHOUT a leading "javascript:" â€” the script will
     * add that prefix automatically.
     *
     * Replace ONLY the content between the backticks below with your minified code,
     * keeping it a single line. Do NOT add leading "javascript:" here.
     *****************************************************************************/

    var codeBody = `(function(){try{var w=window.open('about:blank','_blank');if(!w){alert('Popup blocked â€” allow popups');return;}var q=document.querySelector.bind(document),qs=function(s){return Array.prototype.slice.call(document.querySelectorAll(s))},m=function(k){var e=q('meta[name="'+k+'"],meta[property="'+k+'"]');return e?e.getAttribute('content'):null},jlds=(function(){var o=[];qs('script[type="application/ld+json"]').forEach(function(s){try{o.push(JSON.parse(s.textContent))}catch(e){try{o.push(JSON.parse(s.textContent.replace(/\\/\\/.*?\\n/g,'')))}catch(e){}}});return o;} )(),by=(function(){var t=document.body?document.body.innerText.slice(0,6500):'';var r=t.match(/\\bBy\\s+([A-Z][^\\n]{1,120})/);return r?r[1].trim():null;} )(),metaObj={title:m('og:title')||m('twitter:title')||document.title||null,authors:[],date:m('article:published_time')||m('date')||null,url:m('og:url')||(q('link[rel=canonical]')?q('link[rel=canonical]').href:location.href),verification:[]};var ma=m('author')||m('article:author');if(ma){metaObj.authors.push(ma);metaObj.verification.push('author from meta')}if(jlds.length){metaObj.verification.push('found JSON-LD');jlds.forEach(function(it){var arr=Array.isArray(it)?it:[it];arr.forEach(function(o){var A=o.author||o.creator;if(A){if(Array.isArray(A)){A.forEach(function(x){if(typeof x==='string'){if(metaObj.authors.indexOf(x)===-1)metaObj.authors.push(x)}else if(x&&x.name){if(metaObj.authors.indexOf(x.name)===-1)metaObj.authors.push(x.name)}})}else if(typeof A==='string'){if(metaObj.authors.indexOf(A)===-1)metaObj.authors.push(A)}else if(A&&A.name){if(metaObj.authors.indexOf(A.name)===-1)metaObj.authors.push(A.name)} } if(!metaObj.date&&o.datePublished)metaObj.date=o.datePublished; if(!metaObj.title&&o.headline)metaObj.title=o.headline; if(!metaObj.url&&o.mainEntityOfPage){var me=o.mainEntityOfPage;metaObj.url=(typeof me==='string'?me:(me['@id']||me.url))||metaObj.url}})})}if(!metaObj.authors.length&&by){metaObj.authors=by.split(/\\s+(?:and|,|&)\\s+/).map(function(s){return s.replace(/^By\\s+/i,'').trim()});metaObj.verification.push('visible byline heuristic')}metaObj.authors=metaObj.authors.map(function(s){return s?String(s).replace(/\\s+\\(.*?\\)$/,'').trim():s}).filter(Boolean);var pick=(function(a){if(!a||!a.length) return null;for(var i=0;i<a.length;i++){var s=String(a[i]); if(/^https?:\\/\\//.test(s)) continue; if(s.trim()) return s.trim()}return a[0]||null})(metaObj.authors);var author=pick?pick:'Author not listed',date=(function(d){if(!d) return null;try{var D=new Date(d);if(!isNaN(D))return D.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});}catch(e){}var mm=String(d).match(/(\\d{4}-\\d{2}-\\d{2})/);if(mm)return(new Date(mm[1]+'T00:00:00')).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});return d})(metaObj.date)||'Date not found',title=metaObj.title||'Title not found',url=metaObj.url||location.href,site=(function(){var s=m('og:site_name')||m('publisher')||null; if(s) return s; try{var h=(new URL(location.href)).hostname.replace(/^www\\./,''); return h;}catch(e){return ''}})(),accessed=(function(){var now=new Date();return now.toLocaleDateString('en-US',{year:'numeric',month:'long'});})(),citation=author+', "'+title+'," '+(site||'Publication not listed')+', '+date+', '+url+', accessed '+accessed+'.',json=JSON.stringify(metaObj,null,2);var doc=w.document;doc.open();doc.write('<!doctype html><html><head><meta charset=\"utf-8\"><title>Citation</title></head><body></body></html>');doc.close();var b=doc.body;var p=doc.createElement('pre');p.style.whiteSpace='pre-wrap';p.style.fontSize='16px';p.textContent=citation;b.appendChild(p);b.appendChild(doc.createElement('div'));var h=doc.createElement('div');h.textContent='Extracted metadata (JSON):';h.style.color='#444';h.style.marginTop='12px';b.appendChild(h);var p2=doc.createElement('pre');p2.style.background='#f7f7f8';p2.style.padding='12px';p2.style.borderRadius='6px';p2.style.whiteSpace='pre-wrap';p2.textContent=json;b.appendChild(p2);var v=doc.createElement('div');v.style.marginTop='12px';v.style.color='#666';v.textContent='Verification: '+(metaObj.verification.join(', ')||'none');b.appendChild(v);}catch(e){alert('Bookmarklet error: '+e);}})()`;


    // Build full "javascript:" href (this will be assigned to the install link)
    var full = 'javascript:' + codeBody;

    // Visible page version: change this string on each deploy
    var PAGE_VERSION = "1.0.4";

    // Utility: set link href attribute & property and display raw code
    function configureInstallLink() {
      var link = document.getElementById('install-link');
      // set both attribute and property to be thorough
      link.setAttribute('href', full);
      link.href = full;

      // Also ensure the dragstart event has the correct data for some browsers
      link.addEventListener('dragstart', function(e){
        try {
          // set data for several types so different browsers handle it well
          e.dataTransfer.setData('text/plain', full);
          e.dataTransfer.setData('text/uri-list', full);
          e.dataTransfer.setData('text/javascript', full);
        } catch(err) {
          // ignore; not all browsers allow setting dataTransfer freely
        }
        // re-assign href at dragstart time
        link.setAttribute('href', full);
        link.href = full;
      }, false);

      // Also set href on mousedown / touchstart so the user's gesture picks up the value
      link.addEventListener('mousedown', function(){ link.setAttribute('href', full); link.href = full; }, false);
      link.addEventListener('touchstart', function(){ link.setAttribute('href', full); link.href = full; }, false);

      // Put raw code into <pre>
      var rawEl = document.getElementById('raw');
      rawEl.textContent = full;
    }

    // Copy fallback button
    function configureCopyButton() {
      var btn = document.getElementById('copy-btn');
      btn.addEventListener('click', function(){
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(full).then(function(){
            alert('Bookmarklet code copied to clipboard. Create a new bookmark and paste into the URL field.');
          }).catch(function(){
            window.prompt('Copy this (Ctrl+C):', full);
          });
        } else {
          window.prompt('Copy this (Ctrl+C):', full);
        }
      });
    }

    // Initialize on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function(){
      // set visible version text
      var verEl = document.getElementById('version-text');
      if(verEl) verEl.textContent = PAGE_VERSION;

      configureInstallLink();
      configureCopyButton();

      // If user clicks the link instead of dragging, show instructions (no navigation)
      var installLink = document.getElementById('install-link');
      installLink.addEventListener('click', function(e){
        // If it's a regular click, prevent following the javascript: URL and show instructions
        if(e && e.detail && e.detail < 2){
          e.preventDefault();
          alert('To install the bookmarklet: drag the "ðŸ“š Cite Article" button to your bookmarks bar. If drag does not work, click "Copy bookmarklet" and paste into a new bookmark URL.');
        }
      }, false);
    }, false);
  </script>
</body>
</html>
