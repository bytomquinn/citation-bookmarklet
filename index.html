<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Update version here and below in the visible area -->
  <title>Citation Bookmarklet</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:900px; margin:40px auto; padding:0 20px; color:#111; }
    .bm { display:inline-block; padding:12px 18px; background:#111; color:#fff; border-radius:8px; text-decoration:none; font-weight:600; }
    button { margin-left:12px; padding:9px 12px; }
    pre { background:#f7f7f8; padding:10px; border-radius:6px; overflow:auto; white-space:pre-wrap; word-break:break-word; }
    .note { color:#555; font-size:0.95rem; margin-top:12px; }
    .version { font-size:13px; color:#666; margin-bottom:14px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  </style>
</head>
<body>

  <!--
    Bookmarklet version: 1.0.4
    Edit ONLY the "1.0.4" string in the two places below on each release.
    (1) <title> above
    (2) the visible version line below (PAGE_VERSION variable)
  -->
  <div class="version">Bookmarklet version: <strong id="version-text">1.0.5</strong></div>

  <h1>Install: Citation Bookmarklet</h1>

  <p>Drag the button below to your bookmarks bar to install the bookmarklet; if it is not named, right click -> edit to choose a name.</p>

  <div class="row">
    <!-- Visible anchor users will drag; href will be set at runtime -->
    <a id="install-link" class="bm" href="#">Cite Article</a>
  </div>

   <p>While viewing a web article, click the bookmarklet to create a citation; it should open a new tab with the author, title, publication, date, URL, and date accessed in HBS style.</p>
  
  <!-- INSTALL INSTRUCTIONS (EDIT THIS PARAGRAPH AS NEEDED) -->
<p class="note">
  <strong>Installation notes:</strong>
  If a user already installed an older bookmarklet, they must delete the old bookmark and re-drag the button (bookmarks don't update automatically).
</p>

  <!-- OTHER INSTRUCTIONS (EDIT THIS PARAGRAPH AS NEEDED) -->
<p class="note">
  <strong>Caveats:</strong>
  This is a <strong>starting point.</strong> It is pulling information straight from the website code - for example, photographers may be included as authors. Paste the citation into an endnote and then trim/edit as normal. Tested on many major sites (NYT, WaPo, WSJ, etc), but not guaranteed to work everywhere as I am not a software engineer and don't really know what I am doing.
</p>

  <script>
    /*****************************************************************************
     * IMPORTANT:
     * The variable below (codeBody) must contain your minified bookmarklet body
     * as a single-line string WITHOUT a leading "javascript:" — the script will
     * add that prefix automatically.
     *
     * Replace ONLY the content between the backticks below with your minified code,
     * keeping it a single line. Do NOT add leading "javascript:" here.
     *****************************************************************************/

    var codeBody = "(function(){try{var w=window.open('about:blank','_blank');if(!w){alert('Popup blocked — allow popups');return;}var q=document.querySelector.bind(document),qs=function(s){return Array.prototype.slice.call(document.querySelectorAll(s))},m=function(k){var e=q('meta[name=\"'+k+'\"],meta[property=\"'+k+'\"]');return e?e.getAttribute('content'):null},jlds=(function(){var o=[];qs('script[type=\"application/ld+json\"]').forEach(function(s){try{o.push(JSON.parse(s.textContent))}catch(e){try{o.push(JSON.parse(s.textContent.replace(/\\/\\/.*?\\n/g,'')))}catch(e){}}});return o;} )(),by=(function(){var t=document.body?document.body.innerText.slice(0,6500):'';var r=t.match(/\\bBy\\s+([A-Z][^\\n]{1,120})/);return r?r[1].trim():null;} )(),metaObj={title:m('og:title')||m('twitter:title')||document.title||null,authors:[],date:m('article:published_time')||m('date')||null,url:m('og:url')||(q('link[rel=canonical]')?q('link[rel=canonical]').href:location.href),verification:[]},ma=m('author')||m('article:author');if(ma){metaObj.authors.push(ma);metaObj.verification.push('author from meta')}if(jlds.length){metaObj.verification.push('found JSON-LD');jlds.forEach(function(it){(Array.isArray(it)?it:[it]).forEach(function(o){var A=o.author||o.creator;if(A){(Array.isArray(A)?A:[A]).forEach(function(x){var n=typeof x==='string'?x:x&&x.name;if(n&&metaObj.authors.indexOf(n)===-1)metaObj.authors.push(n)})}if(!metaObj.date&&o.datePublished)metaObj.date=o.datePublished;if(!metaObj.title&&o.headline)metaObj.title=o.headline;if(!metaObj.url&&o.mainEntityOfPage){var me=o.mainEntityOfPage;metaObj.url=(typeof me==='string'?me:(me['@id']||me.url))||metaObj.url}})})}if(!metaObj.authors.length&&by){metaObj.authors=by.split(/\\s+(?:and|,|&)/).map(function(s){return s.replace(/^By\\s+/i,'').trim()});metaObj.verification.push('visible byline heuristic')}metaObj.authors=metaObj.authors.map(function(s){return s?String(s).replace(/\\s+\\(.*?\\)$/,'').trim():s}).filter(Boolean);var authorText=(function(a){if(!a||!a.length)return'Author not listed';if(a.length===1)return a[0];if(a.length===2)return a[0]+' and '+a[1];return a.slice(0,-1).join(', ')+', and '+a[a.length-1]})(metaObj.authors),date=(function(d){if(!d)return null;try{var D=new Date(d);if(!isNaN(D))return D.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}catch(e){}var mm=String(d).match(/(\\d{4}-\\d{2}-\\d{2})/);if(mm)return(new Date(mm[1]+'T00:00:00')).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});return d})(metaObj.date)||'Date not found',title=metaObj.title||'Title not found',url=metaObj.url||location.href,site=(function(){var s=m('og:site_name')||m('publisher');if(s)return s;try{return(new URL(location.href)).hostname.replace(/^www\\./,'')}catch(e){return''}})(),accessed=(function(){var n=new Date();return n.toLocaleDateString('en-US',{year:'numeric',month:'long'})})(),citation=authorText+', \"'+title+'\", '+(site||'Publication not listed')+', '+date+', '+url+', accessed '+accessed+'.',json=JSON.stringify(metaObj,null,2),doc=w.document;doc.open();doc.write('<!doctype html><html><head><meta charset=\"utf-8\"><title>Citation</title></head><body></body></html>');doc.close();var b=doc.body,p=doc.createElement('pre');p.style.whiteSpace='pre-wrap';p.style.fontSize='16px';p.textContent=citation;b.appendChild(p);b.appendChild(doc.createElement('div'));var h=doc.createElement('div');h.textContent='Extracted metadata (JSON):';h.style.color='#444';h.style.marginTop='12px';b.appendChild(h);var p2=doc.createElement('pre');p2.style.background='#f7f7f8';p2.style.padding='12px';p2.style.borderRadius='6px';p2.style.whiteSpace='pre-wrap';p2.textContent=json;b.appendChild(p2);var v=doc.createElement('div');v.style.marginTop='12px';v.style.color='#666';v.textContent='Verification: '+(metaObj.verification.join(', ')||'none');b.appendChild(v);}catch(e){alert('Bookmarklet error: '+e)}})()";



    // Build full "javascript:" href (this will be assigned to the install link)
    var full = 'javascript:' + codeBody;

    // Visible page version: change this string on each deploy
    var PAGE_VERSION = "2/5 10:06 a.m.";

    // Utility: set link href attribute & property and display raw code
    function configureInstallLink() {
      var link = document.getElementById('install-link');
      // set both attribute and property to be thorough
      link.setAttribute('href', full);
      link.href = full;

      // Also ensure the dragstart event has the correct data for some browsers
      link.addEventListener('dragstart', function(e){
        try {
          // set data for several types so different browsers handle it well
          e.dataTransfer.setData('text/plain', full);
          e.dataTransfer.setData('text/uri-list', full);
          e.dataTransfer.setData('text/javascript', full);
        } catch(err) {
          // ignore; not all browsers allow setting dataTransfer freely
        }
        // re-assign href at dragstart time
        link.setAttribute('href', full);
        link.href = full;
      }, false);

      // Also set href on mousedown / touchstart so the user's gesture picks up the value
      link.addEventListener('mousedown', function(){ link.setAttribute('href', full); link.href = full; }, false);
      link.addEventListener('touchstart', function(){ link.setAttribute('href', full); link.href = full; }, false);

      // Put raw code into <pre>
      var rawEl = document.getElementById('raw');
      rawEl.textContent = full;
    }

    // Initialize on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function(){
      // set visible version text
      var verEl = document.getElementById('version-text');
      if(verEl) verEl.textContent = PAGE_VERSION;

      configureInstallLink();
      configureCopyButton();

      // If user clicks the link instead of dragging, show instructions (no navigation)
      var installLink = document.getElementById('install-link');
      installLink.addEventListener('click', function(e){
        // If it's a regular click, prevent following the javascript: URL and show instructions
        if(e && e.detail && e.detail < 2){
          e.preventDefault();
          alert('To install the bookmarklet: drag the "Cite Article" button to your bookmarks bar. If drag does not work, click "Copy bookmarklet" and paste into a new bookmark URL.');
        }
      }, false);
    }, false);
  </script>
</body>
</html>
